<!DOCTYPE html>
<html>
<head>
    <title>Interactive Thompson Sampling Simulator</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.5/jstat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        h1, h2, h3 {
            color: #444;
            margin-top: 30px;
            margin-bottom: 15px;
        }
        h1 {
            text-align: center;
            border-bottom: 2px solid #ddd;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }
        .step-title {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            border-left: 5px solid #5b9bd5;
            margin: 30px 0 20px 0;
        }
        .step-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background-color: #5b9bd5;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            margin: 20px 0;
            display: block;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #4a8bc5;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            margin: 20px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .carousel {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
        }
        .carousel-item {
            width: 30%;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        .hidden {
            display: none;
        }
        .code-block {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            white-space: pre-wrap;
            margin: 20px 0;
        }
        .explanation {
            background-color: #e9f7fe;
            border-left: 5px solid #5b9bd5;
            padding: 15px;
            margin: 20px 0;
        }
        #resetSimulation {
            background-color: #d9534f;
            margin-top: 40px;
        }
        #resetSimulation:hover {
            background-color: #c9433f;
        }
        /* Estilos para el formulario de configuraci√≥n */
        .concert-input {
            background-color: #f8f9fa;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #add-concert {
            background-color: #28a745;
            margin-right: 10px;
        }
        #add-concert:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <h1>Interactive Thompson Sampling Simulator</h1>
    
    <div class="explanation">
        <p>This program shows step by step how to use Thompson Sampling to order concerts in a promotional carousel based on performance data.</p>
        <p>First, configure the concert data:</p>
    </div>

    <!-- INITIAL CONFIGURATION -->
    <div id="config-step" class="step">
        <h2 class="step-title">DATA CONFIGURATION</h2>
        <div class="step-content">
            <form id="concert-config-form">
                <div id="concerts-container">
                    <div class="concert-input">
                        <h3>Concert 1</h3>
                        <div class="form-group">
                            <label>Concert Name:</label>
                            <input type="text" name="name[]" value="Vivaldi: The Four Seasons" required>
                        </div>
                        <div class="form-group">
                            <label>Impressions:</label>
                            <input type="number" name="impressions[]" value="10000" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Clicks:</label>
                            <input type="number" name="clicks[]" value="800" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Views:</label>
                            <input type="number" name="views[]" value="5000" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Purchases:</label>
                            <input type="number" name="purchases[]" value="400" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Gross Margin (USD):</label>
                            <input type="number" name="gross_margin[]" value="12.0" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Color (hex):</label>
                            <input type="color" name="color[]" value="#1f77b4" required>
                        </div>
                    </div>
                    <div class="concert-input">
                        <h3>Concert 2</h3>
                        <div class="form-group">
                            <label>Concert Name:</label>
                            <input type="text" name="name[]" value="Coldplay Tribute" required>
                        </div>
                        <div class="form-group">
                            <label>Impressions:</label>
                            <input type="number" name="impressions[]" value="6000" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Clicks:</label>
                            <input type="number" name="clicks[]" value="600" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Views:</label>
                            <input type="number" name="views[]" value="3000" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Purchases:</label>
                            <input type="number" name="purchases[]" value="300" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Gross Margin (USD):</label>
                            <input type="number" name="gross_margin[]" value="10.0" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Color (hex):</label>
                            <input type="color" name="color[]" value="#ff7f0e" required>
                        </div>
                    </div>
                    <div class="concert-input">
                        <h3>Concert 3</h3>
                        <div class="form-group">
                            <label>Concert Name:</label>
                            <input type="text" name="name[]" value="Queen Tribute" required>
                        </div>
                        <div class="form-group">
                            <label>Impressions:</label>
                            <input type="number" name="impressions[]" value="2000" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Clicks:</label>
                            <input type="number" name="clicks[]" value="100" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Views:</label>
                            <input type="number" name="views[]" value="1000" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Purchases:</label>
                            <input type="number" name="purchases[]" value="50" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Gross Margin (USD):</label>
                            <input type="number" name="gross_margin[]" value="9.0" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Color (hex):</label>
                            <input type="color" name="color[]" value="#2ca02c" required>
                        </div>
                    </div>
                </div>
                <button type="button" id="add-concert">Add Another Concert</button>
                <button type="submit">Start Simulation</button>
            </form>
        </div>
    </div>

    <!-- STEP 1: PERFORMANCE DATA -->
    <div id="step1" class="step">
        <h2 class="step-title">CONCERT PERFORMANCE DATA</h2>
        <div class="step-content">
            <p>These are the historical performance data for each concert:</p>
            <table id="performance-data">
                <thead>
                    <tr>
                        <th>Concert</th>
                        <th>Impressions</th>
                        <th>Clicks</th>
                        <th>Views</th>
                        <th>Purchases</th>
                        <th>Gross Margin</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Will be filled with JavaScript -->
                </tbody>
            </table>
            
            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>
            
            <div class="explanation">
                <p>These are the historical performance data for each concert:</p>
                <ul>
                    <li><strong>IMPRESSIONS</strong> are the number of times each concert was shown</li>
                    <li><strong>CLICKS</strong> are how many times users clicked on the concert</li>
                    <li><strong>VIEWS</strong> are how many times users viewed the details page</li>
                    <li><strong>PURCHASES</strong> are how many tickets were sold</li>
                    <li><strong>GROSS MARGIN</strong> is the average profit per ticket sold in USD</li>
                </ul>
                <p>This data will be used to calculate key metrics such as click-through rate (CTR) and conversion per view rate (CPR).</p>
            </div>
            
            <button id="next1">Next: Calculate Metrics</button>
        </div>
    </div>

    <!-- STEP 2: OBSERVED METRICS CALCULATION -->
    <div id="step2" class="step hidden">
        <h2 class="step-title">STEP 2: OBSERVED METRICS CALCULATION</h2>
        <div class="step-content">
            <p>Calculating CTR (Click-Through Rate) and CPR (Conversion per View Rate):</p>
            <div class="code-block">CTR = Clicks / Impressions
CPR = Purchases / Views</div>
            
            <div id="metrics-calculation">
                <!-- Will be filled with JavaScript -->
            </div>
            
            <div class="chart-container">
                <canvas id="metricsChart"></canvas>
            </div>
            
            <div class="explanation">
                <p>The calculated metrics show:</p>
                <ul>
                    <li>Coldplay has the highest CTR and CPR (10%)</li>
                    <li>Vivaldi has intermediate performance (8% in both metrics)</li>
                    <li>Queen has the lowest values (5% in both metrics)</li>
                </ul>
                <p>If we only considered these observed metrics, Coldplay would always appear first in our carousel. However, Thompson Sampling will allow us to balance exploitation (showing what we know works) with exploration (giving opportunities to less tested options).</p>
            </div>
            
            <button id="next2">Next: Beta Distributions</button>
        </div>
    </div>

    <!-- STEP 3: BETA DISTRIBUTIONS -->
    <div id="step3" class="step hidden">
        <h2 class="step-title">STEP 3: BETA DISTRIBUTION MODELING</h2>
        <div class="step-content">
            <p>For each metric, we model uncertainty using the Beta distribution:</p>
            <div class="code-block">Beta(Œ±, Œ≤) where:
  Œ± = successes + 1
  Œ≤ = failures + 1

The '+1' is known as Laplace smoothing and prevents degenerate distributions.</div>
            
            <div id="beta-parameters">
                <!-- Will be filled with JavaScript -->
            </div>
            
            <div class="explanation">
                <p>The Beta distribution is perfect for modeling conversion rates because:</p>
                <ul>
                    <li>It's constrained between 0 and 1, like our metrics</li>
                    <li>It naturally captures uncertainty based on observed data</li>
                    <li>With more data, the distribution becomes narrower around the true value</li>
                </ul>
                <p>Interpretation of Œ± and Œ≤ parameters:</p>
                <ul>
                    <li><strong>Œ± (alpha)</strong>: represents successes + 1. Higher values indicate higher probability of success.</li>
                    <li><strong>Œ≤ (beta)</strong>: represents failures + 1. Higher values indicate higher probability of failure.</li>
                </ul>
                <p>The shape of the distribution tells us:</p>
                <ul>
                    <li><strong>Tall and narrow curve</strong>: Higher certainty in the estimate</li>
                    <li><strong>Low and wide curve</strong>: Higher uncertainty</li>
                    <li><strong>Shifted to the right</strong>: Higher probability of high values</li>
                    <li><strong>Shifted to the left</strong>: Higher probability of low values</li>
                    <li><strong>Symmetric</strong>: Equal probability at both extremes</li>
                </ul>
            </div>
            
            <button id="next3">Next: Visualize Distributions</button>
        </div>
    </div>

    <!-- STEP 4: DISTRIBUTION VISUALIZATION -->
    <div id="step4" class="step hidden">
        <h2 class="step-title">STEP 4: BETA DISTRIBUTION VISUALIZATION</h2>
        <div class="step-content">
            <div class="chart-container">
                <canvas id="ctrDistributionChart"></canvas>
            </div>
            
            <div class="chart-container">
                <canvas id="cprDistributionChart"></canvas>
            </div>
            
            <div class="explanation">
                <p>Let's analyze the Beta distributions for each concert:</p>
                
                <h3>Curve Interpretation</h3>
                <ul>
                    <li><strong>Curve Height</strong>:
                        <ul>
                            <li>A higher curve indicates higher certainty in the estimate</li>
                            <li>A lower curve indicates higher uncertainty</li>
                        </ul>
                    </li>
                    <li><strong>Curve Width</strong>:
                        <ul>
                            <li>A narrow curve suggests we have a good idea of the true value</li>
                            <li>A wide curve indicates the value could be in a wider range</li>
                        </ul>
                    </li>
                    <li><strong>Peak Position</strong>:
                        <ul>
                            <li>If the peak is more to the right, there's higher probability of high rates</li>
                            <li>If the peak is more to the left, there's higher probability of low rates</li>
                        </ul>
                    </li>
                </ul>
            </div>
            
            <button id="next4">Next: Perform Sampling</button>
        </div>
    </div>

    <!-- STEP 5: THOMPSON SAMPLING -->
    <div id="step5" class="step hidden">
        <h2 class="step-title">STEP 5: THOMPSON SAMPLING</h2>
        <div class="step-content">
            <p>Now we will perform Thompson Sampling, obtaining a random value from each Beta distribution for each concert.</p>
            
            <div id="sampled-values">
                <!-- Will be filled with JavaScript -->
            </div>
            
            <div class="chart-container">
                <canvas id="ctrDistributionWithSamplesChart"></canvas>
            </div>
            
            <div class="chart-container">
                <canvas id="cprDistributionWithSamplesChart"></canvas>
            </div>
            
            <div class="explanation">
                <p>Thompson Sampling has generated a random value from each distribution:</p>
                <ol>
                    <li>The <strong>STARS</strong> show the specific value sampled from each distribution</li>
                    <li>These values are <strong>RANDOM</strong>, so they will vary each time the algorithm runs</li>
                    <li>Higher values are more likely near the peak of each distribution</li>
                    <li>There's a possibility of sampling values far from the mean if there's uncertainty</li>
                </ol>
                <p>This randomness is key: it allows concerts with lower observed performance to have a chance of being selected if their distribution has enough uncertainty.</p>
            </div>
            
            <button id="next5">Next: Calculate Scores</button>
        </div>
    </div>

    <!-- STEP 6: SCORE CALCULATION -->
    <div id="step6" class="step hidden">
        <h2 class="step-title">STEP 6: SCORE CALCULATION</h2>
        <div class="step-content">
            <p>Now we calculate a score for each concert using the formula:</p>
            <div class="code-block">Score = Sampled_CTR √ó Sampled_CPR √ó Gross_Margin</div>
            
            <div id="scores-calculation">
                <!-- Will be filled with JavaScript -->
            </div>
            
            <div class="chart-container">
                <canvas id="scoresChart"></canvas>
            </div>
            
            <div class="explanation">
                <p>The calculated scores determine the final order:</p>
                <ol id="score-ranking">
                    <!-- Will be filled with JavaScript -->
                </ol>
                <p>These scores combine:</p>
                <ul>
                    <li>The probability of a user clicking (CTR)</li>
                    <li>The probability of purchasing after viewing (CPR)</li>
                    <li>The business value of each purchase (Gross Margin)</li>
                </ul>
                <p>The sampled values introduce a controlled element of randomness that allows discovering the true performance of each concert over time.</p>
            </div>
            
            <button id="next6">Next: View Final Ranking</button>
        </div>
    </div>

    <!-- STEP 7: FINAL RANKING -->
    <div id="step7" class="step hidden">
        <h2 class="step-title">STEP 7: FINAL CAROUSEL RANKING</h2>
        <div class="step-content">
            <p>With the calculated scores, we order the concerts in the carousel:</p>
            
            <ol id="final-ranking">
                <!-- Will be filled with JavaScript -->
            </ol>
            
            <div class="carousel" id="carousel-view">
                <!-- Will be filled with JavaScript -->
            </div>
            
            <div class="explanation">
                <p>The carousel is ready! The final order is determined by the Thompson Sampling scores.</p>
                <p>This order is not permanent. Each time Thompson Sampling is applied, new random samples are generated from the distributions, which can result in a different order even with the same underlying data.</p>
            </div>
            
            <button id="next7">Next: Conclusion</button>
        </div>
    </div>

    <!-- CONCLUSION -->
    <div id="conclusion" class="step hidden">
        <h2 class="step-title">CONCLUSION</h2>
        <div class="step-content">
            <div class="explanation">
                <p>Thompson Sampling has allowed us to create a ranking system that:</p>
                <ol>
                    <li><strong>Balances exploitation and exploration:</strong>
                        <ul>
                            <li>Exploits current knowledge about concert performance</li>
                            <li>Explores less tested options to discover their true potential</li>
                        </ul>
                    </li>
                    <li><strong>Handles uncertainty:</strong>
                        <ul>
                            <li>Uses Beta distributions to model uncertainty in CTR and CPR</li>
                            <li>Allows concerts with less data to have opportunities to appear</li>
                        </ul>
                    </li>
                    <li><strong>Optimizes business value:</strong>
                        <ul>
                            <li>Considers multiple metrics (CTR, CPR, Gross Margin)</li>
                            <li>Combines these metrics into a single score for each concert</li>
                        </ul>
                    </li>
                    <li><strong>Adapts over time:</strong>
                        <ul>
                            <li>Distributions are updated with new data</li>
                            <li>The system improves its accuracy with more interactions</li>
                        </ul>
                    </li>
                </ol>
                <p>This approach is particularly useful for:</p>
                <ul>
                    <li>Promotional carousels</li>
                    <li>Recommendation systems</li>
                    <li>Conversion optimization</li>
                    <li>Multi-armed A/B testing</li>
                </ul>
                <p>Thank you for using the Thompson Sampling Simulator!</p>
            </div>
            
            <button id="resetSimulation">Reset Simulation</button>
        </div>
    </div>

    <script>
        // Funciones auxiliares
        function formatNumber(num, decimals = 4) {
            return num.toFixed(decimals);
        }

        function darkenColor(color, amount) {
            const num = parseInt(color.replace('#', ''), 16);
            const r = Math.max(0, (num >> 16) - amount * 255);
            const g = Math.max(0, ((num >> 8) & 0x00FF) - amount * 255);
            const b = Math.max(0, (num & 0x0000FF) - amount * 255);
            return '#' + (g | (b << 8) | (r << 16)).toString(16).padStart(6, '0');
        }

        function lightenColor(color, amount) {
            const num = parseInt(color.replace('#', ''), 16);
            const r = Math.min(255, (num >> 16) + amount * 255);
            const g = Math.min(255, ((num >> 8) & 0x00FF) + amount * 255);
            const b = Math.min(255, (num & 0x0000FF) + amount * 255);
            return '#' + (g | (b << 8) | (r << 16)).toString(16).padStart(6, '0');
        }

        // Variables globales
        let observedMetrics = {};
        let betaParameters = {};
        let sampledValues = {};
        let scores = {};
        let rankings = [];

        // Configuraci√≥n inicial
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('concert-config-form');
            const addButton = document.getElementById('add-concert');
            let concertCount = 3; // Ya tenemos 3 conciertos precargados

            // Funci√≥n para a√±adir un nuevo concierto
            addButton.addEventListener('click', function() {
                concertCount++;
                const container = document.getElementById('concerts-container');
                const newConcert = document.querySelector('.concert-input').cloneNode(true);
                
                // Actualizar el t√≠tulo
                newConcert.querySelector('h3').textContent = `Concert ${concertCount}`;
                
                // Limpiar los valores
                newConcert.querySelectorAll('input').forEach(input => input.value = '');
                
                container.appendChild(newConcert);
            });

            // Manejar el env√≠o del formulario
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Recopilar datos del formulario
                const formData = new FormData(form);
                const concerts = {};
                
                // Procesar los datos del formulario
                const names = formData.getAll('name[]');
                const impressions = formData.getAll('impressions[]');
                const clicks = formData.getAll('clicks[]');
                const views = formData.getAll('views[]');
                const purchases = formData.getAll('purchases[]');
                const gross_margins = formData.getAll('gross_margin[]');
                const colors = formData.getAll('color[]');
                
                // Crear objeto de conciertos
                names.forEach((name, index) => {
                    concerts[name] = {
                        impressions: parseInt(impressions[index]),
                        clicks: parseInt(clicks[index]),
                        views: parseInt(views[index]),
                        purchases: parseInt(purchases[index]),
                        gross_margin: parseFloat(gross_margins[index]),
                        color: colors[index]
                    };
                });
                
                // Actualizar los datos globales
                window.concerts = concerts;
                
                // Ocultar configuraci√≥n y mostrar paso 1
                hideStep('config-step');
                showStep('step1');
                initializeStep1();
            });

            // Configurar los botones de navegaci√≥n
            document.getElementById('next1').addEventListener('click', () => {
                hideStep('step1');
                showStep('step2');
                initializeStep2();
            });
            
            document.getElementById('next2').addEventListener('click', () => {
                hideStep('step2');
                showStep('step3');
                initializeStep3();
            });
            
            document.getElementById('next3').addEventListener('click', () => {
                hideStep('step3');
                showStep('step4');
                initializeStep4();
            });
            
            document.getElementById('next4').addEventListener('click', () => {
                hideStep('step4');
                showStep('step5');
                initializeStep5();
            });
            
            document.getElementById('next5').addEventListener('click', () => {
                hideStep('step5');
                showStep('step6');
                initializeStep6();
            });
            
            document.getElementById('next6').addEventListener('click', () => {
                hideStep('step6');
                showStep('step7');
                initializeStep7();
            });
            
            document.getElementById('next7').addEventListener('click', () => {
                hideStep('step7');
                showStep('conclusion');
            });
            
            document.getElementById('resetSimulation').addEventListener('click', () => {
                location.reload();
            });
        });

        // Funci√≥n para mostrar un paso
        function showStep(stepId) {
            document.getElementById(stepId).classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        // Funci√≥n para ocultar un paso
        function hideStep(stepId) {
            document.getElementById(stepId).classList.add('hidden');
        }

        // PASO 1: Datos de rendimiento
        function initializeStep1() {
            // Llenar la tabla de datos
            const tbody = document.querySelector('#performance-data tbody');
            tbody.innerHTML = '';
            
            Object.entries(window.concerts).forEach(([name, data]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${name}</td>
                    <td>${data.impressions}</td>
                    <td>${data.clicks}</td>
                    <td>${data.views}</td>
                    <td>${data.purchases}</td>
                    <td>$${data.gross_margin.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
            
            // Crear gr√°fico de rendimiento
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            const impressionsData = Object.values(window.concerts).map(c => c.impressions);
            const clicksData = Object.values(window.concerts).map(c => c.clicks);
            const viewsData = Object.values(window.concerts).map(c => c.views);
            const purchasesData = Object.values(window.concerts).map(c => c.purchases);
            const colors = Object.values(window.concerts).map(c => c.color);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(window.concerts),
                    datasets: [
                        {
                            label: 'Impressions',
                            data: impressionsData,
                            backgroundColor: colors,
                            borderColor: colors.map(c => darkenColor(c, 0.2)),
                            borderWidth: 1
                        },
                        {
                            label: 'Clicks',
                            data: clicksData,
                            backgroundColor: colors.map(c => lightenColor(c, 0.3)),
                            borderColor: colors,
                            borderWidth: 1
                        },
                        {
                            label: 'Views',
                            data: viewsData,
                            backgroundColor: colors.map(c => lightenColor(c, 0.5)),
                            borderColor: colors,
                            borderWidth: 1
                        },
                        {
                            label: 'Purchases',
                            data: purchasesData,
                            backgroundColor: colors.map(c => lightenColor(c, 0.7)),
                            borderColor: colors,
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            type: 'logarithmic'
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Concert Performance Data',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        // PASO 2: C√°lculo de m√©tricas
        function initializeStep2() {
            // Calcular m√©tricas
            const metricsDiv = document.getElementById('metrics-calculation');
            metricsDiv.innerHTML = '';
            
            Object.entries(window.concerts).forEach(([name, data]) => {
                const ctr = data.clicks / data.impressions;
                const cpr = data.purchases / data.views;
                
                // Almacenar m√©tricas
                observedMetrics[name] = { ctr, cpr };
                
                const p = document.createElement('p');
                p.innerHTML = `<strong>${name}:</strong><br>
                    CTR = ${data.clicks} / ${data.impressions} = ${formatNumber(ctr)}<br>
                    CPR = ${data.purchases} / ${data.views} = ${formatNumber(cpr)}`;
                metricsDiv.appendChild(p);
            });
            
            // Crear gr√°fico de m√©tricas
            const ctx = document.getElementById('metricsChart').getContext('2d');
            
            const labels = Object.keys(window.concerts);
            const ctrData = labels.map(name => observedMetrics[name].ctr);
            const cprData = labels.map(name => observedMetrics[name].cpr);
            const colors = labels.map(name => window.concerts[name].color);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'CTR',
                            data: ctrData,
                            backgroundColor: colors,
                            borderColor: colors.map(c => darkenColor(c, 0.2)),
                            borderWidth: 1
                        },
                        {
                            label: 'CPR',
                            data: cprData,
                            backgroundColor: colors.map(c => lightenColor(c, 0.3)),
                            borderColor: colors,
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: Math.max(...ctrData, ...cprData) * 1.2,
                            title: {
                                display: true,
                                text: 'Rate'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Observed Metrics: CTR and CPR',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        // PASO 3: Distribuciones Beta
        function initializeStep3() {
            // Calcular par√°metros Beta
            const betaDiv = document.getElementById('beta-parameters');
            betaDiv.innerHTML = '';
            
            Object.entries(window.concerts).forEach(([name, data]) => {
                // Para CTR
                const ctrAlpha = data.clicks + 1;
                const ctrBeta = (data.impressions - data.clicks) + 1;
                // Para CPR
                const cprAlpha = data.purchases + 1;
                const cprBeta = (data.views - data.purchases) + 1;
                
                // Almacenar par√°metros
                betaParameters[name] = { ctrAlpha, ctrBeta, cprAlpha, cprBeta };
                
                const p = document.createElement('p');
                p.innerHTML = `<strong>${name}:</strong><br>
                    CTR: Œ± = ${ctrAlpha}, Œ≤ = ${ctrBeta}<br>
                    CPR: Œ± = ${cprAlpha}, Œ≤ = ${cprBeta}`;
                betaDiv.appendChild(p);
            });
            
            // Crear gr√°fico de distribuciones Beta para CTR
            const ctxCTR = document.getElementById('ctrDistributionChart').getContext('2d');
            const labels = Object.keys(window.concerts);
            const colors = labels.map(name => window.concerts[name].color);
            
            // Generar puntos para la distribuci√≥n
            const x = Array.from({length: 100}, (_, i) => i / 100);
            const datasets = labels.map((name, i) => {
                const { ctrAlpha, ctrBeta } = betaParameters[name];
                const y = x.map(xi => betaPDF(xi, ctrAlpha, ctrBeta));
                return {
                    label: `${name} CTR`,
                    data: y,
                    borderColor: colors[i],
                    backgroundColor: colors[i] + '40',
                    fill: true,
                    tension: 0.4
                };
            });
            
            new Chart(ctxCTR, {
                type: 'line',
                data: {
                    labels: x,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Click-Through Rate (CTR)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Probability Density'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Beta Distributions for CTR',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });

            // Crear gr√°fico de distribuciones Beta para CPR
            const ctxCPR = document.getElementById('cprDistributionChart').getContext('2d');
            const datasetsCPR = labels.map((name, i) => {
                const { cprAlpha, cprBeta } = betaParameters[name];
                const y = x.map(xi => betaPDF(xi, cprAlpha, cprBeta));
                return {
                    label: `${name} CPR`,
                    data: y,
                    borderColor: colors[i],
                    backgroundColor: colors[i] + '40',
                    fill: true,
                    tension: 0.4
                };
            });
            
            new Chart(ctxCPR, {
                type: 'line',
                data: {
                    labels: x,
                    datasets: datasetsCPR
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Conversion Rate (CPR)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Probability Density'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Beta Distributions for CPR',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        // PASO 5: Muestreo de Thompson
        function initializeStep5() {
            // Realizar muestreo de Thompson
            const sampledValuesDiv = document.getElementById('sampled-values');
            sampledValuesDiv.innerHTML = '';
            
            Object.entries(window.concerts).forEach(([name, data]) => {
                const ctr = betaSample(betaParameters[name].ctrAlpha, betaParameters[name].ctrBeta);
                const cpr = betaSample(betaParameters[name].cprAlpha, betaParameters[name].cprBeta);
                
                // Almacenar valores muestreados
                sampledValues[name] = { ctr, cpr };
                
                const p = document.createElement('p');
                p.innerHTML = `<strong>${name}:</strong><br>
                    CTR = ${formatNumber(ctr)}<br>
                    CPR = ${formatNumber(cpr)}`;
                sampledValuesDiv.appendChild(p);
            });
            
            // Generar puntos para la distribuci√≥n
            const x = Array.from({length: 100}, (_, i) => i / 100);
            const labels = Object.keys(window.concerts);
            const colors = labels.map(name => window.concerts[name].color);

            // Crear gr√°fico de distribuciones Beta con muestras para CTR
            const ctxCTR = document.getElementById('ctrDistributionWithSamplesChart').getContext('2d');
            const datasetsCTR = labels.map((name, i) => {
                const { ctrAlpha, ctrBeta } = betaParameters[name];
                const y = x.map(xi => betaPDF(xi, ctrAlpha, ctrBeta));
                return {
                    label: `${name} CTR`,
                    data: y,
                    borderColor: colors[i],
                    backgroundColor: colors[i] + '40',
                    fill: true,
                    tension: 0.4
                };
            });

            // A√±adir puntos muestreados para CTR
            labels.forEach((name, i) => {
                const sampledValue = sampledValues[name].ctr;
                const yValue = betaPDF(sampledValue, betaParameters[name].ctrAlpha, betaParameters[name].ctrBeta);
                datasetsCTR.push({
                    label: `${name} CTR Sample`,
                    data: [{
                        x: sampledValue,
                        y: yValue
                    }],
                    type: 'scatter',
                    backgroundColor: colors[i],
                    borderColor: darkenColor(colors[i], 0.2),
                    pointRadius: 10,
                    pointStyle: 'star',
                    pointBackgroundColor: colors[i],
                    pointBorderColor: darkenColor(colors[i], 0.2),
                    pointBorderWidth: 2
                });
            });
            
            new Chart(ctxCTR, {
                type: 'line',
                data: {
                    labels: x,
                    datasets: datasetsCTR
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Click-Through Rate (CTR)'
                            },
                            type: 'linear',
                            min: 0,
                            max: 1
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Probability Density'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Beta Distributions for CTR with Samples',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });

            // Crear gr√°fico de distribuciones Beta con muestras para CPR
            const ctxCPR = document.getElementById('cprDistributionWithSamplesChart').getContext('2d');
            const datasetsCPR = labels.map((name, i) => {
                const { cprAlpha, cprBeta } = betaParameters[name];
                const y = x.map(xi => betaPDF(xi, cprAlpha, cprBeta));
                return {
                    label: `${name} CPR`,
                    data: y,
                    borderColor: colors[i],
                    backgroundColor: colors[i] + '40',
                    fill: true,
                    tension: 0.4
                };
            });

            // A√±adir puntos muestreados para CPR
            labels.forEach((name, i) => {
                const sampledValue = sampledValues[name].cpr;
                const yValue = betaPDF(sampledValue, betaParameters[name].cprAlpha, betaParameters[name].cprBeta);
                datasetsCPR.push({
                    label: `${name} CPR Sample`,
                    data: [{
                        x: sampledValue,
                        y: yValue
                    }],
                    type: 'scatter',
                    backgroundColor: colors[i],
                    borderColor: darkenColor(colors[i], 0.2),
                    pointRadius: 10,
                    pointStyle: 'star',
                    pointBackgroundColor: colors[i],
                    pointBorderColor: darkenColor(colors[i], 0.2),
                    pointBorderWidth: 2
                });
            });
            
            new Chart(ctxCPR, {
                type: 'line',
                data: {
                    labels: x,
                    datasets: datasetsCPR
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Conversion Rate (CPR)'
                            },
                            type: 'linear',
                            min: 0,
                            max: 1
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Probability Density'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Beta Distributions for CPR with Samples',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        // PASO 6: Calcular scores
        function initializeStep6() {
            // Calcular scores
            const scoresDiv = document.getElementById('scores-calculation');
            scoresDiv.innerHTML = '';
            
            Object.entries(window.concerts).forEach(([name, data]) => {
                const score = sampledValues[name].ctr * sampledValues[name].cpr * data.gross_margin;
                
                // Almacenar score
                scores[name] = score;
                
                const p = document.createElement('p');
                p.innerHTML = `<strong>${name}:</strong><br>
                    Score = ${formatNumber(sampledValues[name].ctr)} √ó ${formatNumber(sampledValues[name].cpr)} √ó $${data.gross_margin.toFixed(2)} = $${formatNumber(score)}`;
                scoresDiv.appendChild(p);
            });
            
            // Crear gr√°fico de scores
            const ctx = document.getElementById('scoresChart').getContext('2d');
            const labels = Object.keys(window.concerts);
            const data = labels.map(name => scores[name]);
            const colors = labels.map(name => window.concerts[name].color);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Score',
                            data: data,
                            backgroundColor: colors,
                            borderColor: colors.map(c => darkenColor(c, 0.2)),
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: Math.max(...data) * 1.2,
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Thompson Sampling Scores',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        // PASO 7: Ver ranking final
        function initializeStep7() {
            // Ordenar conciertos por score
            rankings = Object.entries(scores).sort((a, b) => b[1] - a[1]).map(entry => entry[0]);
            
            // Crear carrusel
            const carouselDiv = document.getElementById('carousel-view');
            carouselDiv.innerHTML = '';
            
            const carouselItems = document.createElement('div');
            carouselItems.className = 'carousel';
            
            rankings.forEach(name => {
                const item = document.createElement('div');
                item.className = 'carousel-item';
                item.style.backgroundColor = window.concerts[name].color;
                item.innerHTML = name;
                carouselItems.appendChild(item);
            });
            
            carouselDiv.appendChild(carouselItems);
        }

        // Funci√≥n para distribuci√≥n Beta PDF
        function betaPDF(x, alpha, beta) {
            return jStat.beta.pdf(x, alpha, beta);
        }

        // Funci√≥n para muestrear de distribuci√≥n Beta
        function betaSample(alpha, beta) {
            return jStat.beta.sample(alpha, beta);
        }
    </script>
</body>
</html>